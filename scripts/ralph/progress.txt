## Codebase Patterns
- Use Textual framework for TUI (>=0.50.0) - imports from `textual.app`, `textual.containers`, `textual.widgets`
- TUI is separate module `echolog_tui.py`, imported lazily in `echolog.py` when `tui` action is used
- EchologRecorder class in `echolog.py` is the core recording engine - TUI should interact with this
- Tests run via `pytest` in the virtual environment
- Activate venv with `source .venv/bin/activate` before running commands

---

## 2026-01-11 - US-001
Thread: https://ampcode.com/threads/T-019bacfb-822c-775e-81d5-13ed4be60bee
- Implemented: Basic TUI application with Textual framework
- Files changed:
  - echolog_tui.py (new) - TUI module with Dashboard, StatusPanel, TimerPanel, ChunkPanel, InfoPanel, LogPanel
  - echolog.py (modified) - Added import and call to run_tui() for `tui` action
- Acceptance criteria met:
  - `echolog tui` launches the TUI application
  - TUI displays main dashboard on startup
  - Application exits cleanly with `q` key
  - Typecheck passes (Python imports work)
- **Learnings for future iterations:**
  - Textual uses CSS-like styling via DEFAULT_CSS class attributes
  - Bindings are defined via BINDINGS class attribute with Binding objects
  - Use compose() method to build widget tree, on_mount() for initialization
  - query_one() to find widgets by ID/class, update() to refresh labels
---

## 2026-01-11 - US-002
Thread: https://ampcode.com/threads/T-019bacfe-196f-755c-b49f-1407d0f6d8c9
- Implemented: Recording status display with real-time updates
- Files changed:
  - echolog_tui.py (modified) - Added recorder integration, StatusPanel CSS styling with status-idle/status-recording classes, periodic status polling via set_interval()
  - echolog.py (modified) - Pass recorder instance to run_tui()
- Acceptance criteria met:
  - Status panel shows "Idle" (○) when not recording
  - Status panel shows "Recording" (●) with green color when active
  - Session ID displayed when recording
  - Status updates immediately via 0.5s polling interval
  - Typecheck passes
- **Learnings for future iterations:**
  - Textual's set_interval() is ideal for periodic status polling
  - Track _last_status to avoid redundant UI updates
  - Use TYPE_CHECKING import guard for type hints to avoid circular imports
  - CSS classes can be dynamically added/removed via add_class()/remove_class()
---

## 2026-01-11 - US-003
Thread: https://ampcode.com/threads/T-019bad00-968e-73cb-9fd5-9cd645773e28
- Implemented: Elapsed time display with real-time updates
- Files changed:
  - echolog.py (modified) - Added `elapsed_seconds` field to `get_status()` method
  - echolog_tui.py (modified) - Added `_update_timer()` method with 1-second polling, reset timer to 00:00:00 when idle
- Acceptance criteria met:
  - Timer displays HH:MM:SS format
  - Timer updates every second during recording
  - Timer shows 00:00:00 when idle
  - Typecheck passes
- **Learnings for future iterations:**
  - `get_status()` is the interface for TUI to get recorder state - extend it for new features
  - `_recording_start_monotonic` is used to calculate elapsed time (monotonic clock)
  - Use separate polling intervals for different update frequencies (0.5s for status, 1s for timer)
---

## 2026-01-11 - US-004
Thread: https://ampcode.com/threads/T-019bad02-a916-77ce-9399-8c8462d65d59
- Implemented: Segment progress display with progress bar
- Files changed:
  - echolog.py (modified) - Added segment progress fields to `get_status()`: `segment_duration_seconds`, `segment_elapsed_seconds`, `segment_remaining_seconds`, `current_chunk_number`
  - echolog_tui.py (modified) - Added `SegmentPanel` widget with progress bar, chunk counter, and time remaining display
- Acceptance criteria met:
  - Progress bar shows time elapsed in current segment (█ filled, ░ empty)
  - Displays current chunk number (e.g., "Chunk 3/∞")
  - Shows time remaining until next chunk in MM:SS format
  - Progress resets when new chunk starts (via modulo calculation)
  - Typecheck passes
- **Learnings for future iterations:**
  - Segment progress calculated from elapsed_seconds % segment_duration
  - Use `_segment_duration_seconds` from EchologRecorder for accurate segment length
  - Progress bar rendering: calculate percentage, fill chars with █ and ░
---

## 2026-01-11 - US-005
Thread: https://ampcode.com/threads/T-019bad05-2b33-77bf-92f6-d25c998a32d4
- Implemented: Info panel with device and settings display
- Files changed:
  - echolog.py (modified) - Extended `get_status()` to return device_name, format, sample_rate
  - echolog_tui.py (modified) - Added `_sync_info_panel()` method to populate InfoPanel from recorder config
- Acceptance criteria met:
  - Info panel shows current audio device name (or "Auto-detect")
  - Shows audio format (OGG/Opus, FLAC, etc.)
  - Shows sample rate
  - Shows segment duration setting
  - Typecheck passes
- **Learnings for future iterations:**
  - Extend `get_status()` to expose config data to TUI rather than accessing config directly
  - Format display names: {'ogg': 'OGG/Opus', 'mp3': 'MP3', 'flac': 'FLAC'}
  - InfoPanel.update_info() accepts kwargs to update individual fields
---

## 2026-01-11 - US-005
Thread: https://ampcode.com/threads/T-019bad08-199d-7567-912c-fb3f3cfd3aff
- Implemented: Chunk list display with real-time updates
- Files changed:
  - echolog.py (modified) - Extended `get_status()` to return `chunks` list with filename, size_bytes, and finalized status
  - echolog_tui.py (modified) - Updated `ChunkPanel` with `update_chunks()` method, added `_sync_chunks()` to sync from recorder
- Acceptance criteria met:
  - List shows all chunks created in current session (via get_status() chunks field)
  - Each chunk shows filename and size (MB format)
  - Completed chunks marked with ✓ checkmark
  - Current/in-progress chunk indicated with ◐ and "(rec...)"
  - List auto-scrolls to show last 6 chunks
  - Chunk list cleared when recording stops
  - Typecheck passes
- **Learnings for future iterations:**
  - Use `_session_dir` to find chunks rather than reconstructing path from session_id
  - `_finalized_chunks` set tracks which chunks have been finalized by ffmpeg
  - Pattern `{session_name}_*_chunk_*.{fmt}` matches all chunks for a session
---

## 2026-01-11 - US-006
Thread: https://ampcode.com/threads/T-019bad0a-c7f0-748d-a097-c66f2dbe5bcd
- Implemented: Start recording via keyboard with 'r' key
- Files changed:
  - echolog_tui.py (modified) - Added SessionNameModal modal screen with Input widget, updated action_start_recording() to show modal, added _on_session_name_submitted() callback to start recording
- Acceptance criteria met:
  - Pressing 'r' opens session name prompt (SessionNameModal)
  - After entering name and pressing Enter, recording starts via recorder.start_recording()
  - Status updates to "Recording" (via _sync_recorder_status with force refresh)
  - Error shown if recording fails (logged to LogPanel)
  - Typecheck passes
- **Learnings for future iterations:**
  - Textual's ModalScreen[T] with generic type T allows returning values via dismiss(value)
  - push_screen() accepts a callback function that receives the dismissed value
  - Use on_input_submitted() to handle Enter key in Input widgets
  - Force status sync by setting _last_status = None before calling _sync_recorder_status()
---

## 2026-01-11 - US-007
Thread: https://ampcode.com/threads/T-019bad0c-a9fb-700e-a4ae-c213695f6522
- Implemented: Stop recording via keyboard with 's' key
- Files changed:
  - echolog_tui.py (modified) - Replaced placeholder action_stop_recording() with full implementation that calls recorder.stop_recording()
- Acceptance criteria met:
  - Pressing 's' stops active recording via recorder.stop_recording()
  - Confirmation message shown in LogPanel (before and after stop)
  - Status updates to "Idle" (via _sync_recorder_status with force refresh)
  - Final chunk is properly finalized (handled by recorder.stop_recording())
  - Typecheck passes
- **Learnings for future iterations:**
  - Pattern for TUI actions: check recorder exists, check state (is_recording), log before action, call recorder method, log result, force sync UI
  - Same force status sync pattern (_last_status = None) used as in start recording
---

## 2026-01-11 - US-008 & US-009
Thread: https://ampcode.com/threads/T-019bad0e-f333-7511-971e-55f491dadfc7
- Implemented: US-008 was already implemented in US-005. US-009 adds disk space display.
- Files changed:
  - echolog.py (modified) - Added `disk_free_bytes` to `get_status()` using `os.statvfs()`
  - echolog_tui.py (modified) - Added `disk_free_bytes` field to InfoPanel, warning CSS class for low disk, updated `_sync_info_panel()` to format disk space
  - tasks/prd-tui-interface.md (modified) - Marked US-008 and US-009 as complete
- Acceptance criteria met:
  - Info panel shows free space in output directory (e.g., "45.2 GB free")
  - Updates periodically during recording via `_update_timer()` -> `_sync_info_panel()`
  - Warning color (orange) when space is low (<1GB)
  - Typecheck passes
- **Learnings for future iterations:**
  - Use `os.statvfs(path)` to get disk space: `f_bavail * f_frsize` = free bytes
  - Pass pre-fetched status dict between sync methods to avoid redundant `get_status()` calls
  - InfoPanel.update_info() accepts kwargs including `disk_free_bytes` for warning logic
---

## 2026-01-11 - US-013
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented: Help overlay modal with keyboard shortcuts
- Files changed:
  - echolog_tui.py (modified) - Added HelpModal class with keyboard shortcuts display, updated action_show_help() to push modal
  - scripts/ralph/prd.json (modified) - Synced PRD to mark US-006, US-007, US-009, US-010, US-011, US-012, US-013 as passing
- Acceptance criteria met:
  - Pressing '?' shows modal overlay with shortcuts list
  - Lists all keybindings: r, s, d, q, ?
  - Any key or Esc dismisses overlay
  - Typecheck passes
- **Learnings for future iterations:**
  - ModalScreen[None] used when no return value needed (unlike ModalScreen[str] for SessionNameModal)
  - on_key() event handler catches any key press for "press any key to close" behavior
  - PRD and progress.txt can get out of sync - always verify code state before implementing
---

## 2026-01-11 - US-014
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented: Device selection screen with list navigation
- Files changed:
  - echolog_tui.py (modified) - Added DeviceSelectionScreen modal with device list, arrow key navigation, and selection callback
  - scripts/ralph/prd.json (modified) - Marked US-014 as passing
- Acceptance criteria met:
  - Pressing 'd' opens device selection screen (DeviceSelectionScreen modal)
  - Lists all available audio sources from detect_audio_devices()
  - Current device highlighted with green ● marker
  - Arrow keys navigate list (up/down), Enter selects
  - Esc returns to dashboard without changing device
  - Selected device used for next recording (saved to recorder config)
  - Typecheck passes
- **Learnings for future iterations:**
  - DeviceSelectionScreen uses ModalScreen[str] to return the selected device name
  - _update_selection() updates CSS classes for visual feedback on navigation
  - Set auto_detect_device to 'false' when user explicitly selects a device
  - _sync_info_panel() refreshes the InfoPanel to show the new device immediately
---

## 2026-01-11 - US-015
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented: Time limit indicator in InfoPanel
- Files changed:
  - echolog.py (modified) - Added `time_limit_seconds` and `time_limit_remaining_seconds` to `get_status()` return dict
  - echolog_tui.py (modified) - Updated `InfoPanel` with `time_limit` and `time_limit_remaining` fields, `_render_info()` conditionally shows limit line, `_sync_info_panel()` formats time limit values
- Acceptance criteria met:
  - Info panel shows remaining time when time_limit is configured (e.g., "Limit: 2h (1h 30m left)")
  - Indicator hidden when no limit set (time_limit=0) - empty string means no display
  - Updates during recording via `_sync_info_panel()` called from `_update_timer()`
  - Typecheck passes (Python imports verified)
- **Learnings for future iterations:**
  - `_time_limit_seconds` is stored on EchologRecorder, set during `start_recording()`
  - Time limit remaining calculated as `max(0, time_limit_seconds - elapsed_seconds)`
  - InfoPanel uses `height: auto; min-height: 7;` to accommodate variable number of lines
  - Format time as "Xh Ym" for hours+minutes, "Xm" for minutes only, "Xs" for seconds
---

## 2026-01-11 - US-016
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented: Graceful quit during recording with confirmation dialog
- Files changed:
  - echolog_tui.py (modified) - Added QuitConfirmModal class with Y/N keybindings, updated action_quit() to check recording state and show modal, added _on_quit_confirmed() callback to stop recording before exit
- Acceptance criteria met:
  - Pressing 'q' while recording shows confirmation dialog (QuitConfirmModal)
  - Confirming with 'Y' stops recording then exits
  - Canceling with 'N' or Esc returns to dashboard (logs "Quit cancelled")
  - Final chunk is finalized before exit (via recorder.stop_recording())
  - Typecheck passes
- **Learnings for future iterations:**
  - QuitConfirmModal uses ModalScreen[bool] to return confirmation (True/False)
  - Pattern: action_quit() checks recorder.is_recording() before showing modal
  - Same callback pattern as SessionNameModal - push_screen() with callback function
  - Log messages before and after stop_recording() for user feedback
---

## 2026-01-11 - US-017
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented: Footer with keyboard hints in specified format
- Files changed:
  - echolog_tui.py (modified) - Updated BINDINGS descriptions to use [X]Label format, reordered to match acceptance criteria
- Acceptance criteria met:
  - Footer shows: [R]ecord [S]top [D]evices [?]Help [Q]uit
  - Footer visible at all times on dashboard (via Textual's Footer widget)
  - Typecheck passes
- **Learnings for future iterations:**
  - Textual's Footer widget automatically displays BINDINGS in order they're defined
  - Binding description parameter controls display text - use [X]Label format for keyboard hints
  - Binding order in BINDINGS list = order in footer display
---
